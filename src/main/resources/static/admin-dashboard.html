<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cast2Vote - Admin Dashboard</title>
    <style>
    /* ===== Global ===== */
    * { box-sizing: border-box; }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background: #fdfdfd;
        color: #333;
    }

    /* ===== Header ===== */
    header {
        background: #fff;
        color: #333;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        position: sticky;
        top: 0;
        z-index: 1000;
        border-bottom: 1px solid #e0e0e0;
        border-radius: 0;
    }
    header h1 {
        margin: 0;
        font-size: 26px;
        font-weight: 600;
    }
    header button {
        background: #007bff;
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    header button:hover {
        background: #0056b3;
        transform: translateY(-2px);
    }

    /* ===== Container ===== */
    .container {
        max-width: 1200px;
        margin: 30px auto;
        padding: 0 20px;
    }

    /* ===== Headings ===== */
    h2 {
        color: #222;
        margin-top: 30px;
        margin-bottom: 15px;
        font-size: 22px;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 5px;
    }

    /* ===== Countdown ===== */
    #countdown {
        font-weight: bold;
        margin-bottom: 20px;
        background: #fff;
        padding: 15px 20px;
        border-radius: 12px;
        box-shadow: 0 6px 12px rgba(0,0,0,0.05);
        display: inline-block;
        font-size: 18px;
    }

    /* ===== Tables ===== */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 25px;
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 6px 12px rgba(0,0,0,0.05);
    }
    th, td {
        padding: 14px 18px;
        text-align: left;
        font-size: 16px;
    }
    th {
        background: #f8f9fa;
        color: #333;
        font-weight: 600;
    }
    tr:hover {
        background: #f1f3f5;
        transition: 0.3s;
    }

    /* ===== Inputs ===== */
    input {
        padding: 10px 14px;
        margin: 6px 0;
        border-radius: 8px;
        border: 1px solid #ccc;
        width: 100%;
        font-size: 16px;
        background: #fff;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.03);
        transition: all 0.3s;
    }
    input:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 8px rgba(0,123,255,0.2);
    }

    /* ===== Buttons ===== */
    button {
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin: 4px;
        font-weight: bold;
        transition: all 0.3s ease;
        font-size: 15px;
    }
    button:disabled {
        background: #aaa;
        cursor: not-allowed;
    }

    /* Action buttons */
    .approve { background: #28a745; color: #fff; }
    .reject { background: #dc3545; color: #fff; }
    .delete { background: #ffc107; color: #fff; }
    .send-winner { background: #17a2b8; color: #fff; }

    .approve:hover { background: #218838; transform: translateY(-2px); }
    .reject:hover { background: #c82333; transform: translateY(-2px); }
    .delete:hover { background: #e0a800; transform: translateY(-2px); }
    .send-winner:hover { background: #138496; transform: translateY(-2px); }

    /* ===== Messages ===== */
    p {
        margin: 8px 0 14px 0;
        font-weight: 600;
        font-size: 16px;
    }

    /* ===== Section Buttons ===== */
    #setElectionBtn, #addCandidateBtn {
        background: #007bff;
        color: #fff;
        width: auto;
    }
    #setElectionBtn:hover, #addCandidateBtn:hover {
        background: #0056b3;
    }

    /* ===== Responsive ===== */
    @media(max-width: 768px) {
        header h1 { font-size: 20px; }
        th, td { font-size: 14px; padding: 10px 12px; }
        button { font-size: 14px; padding: 6px 12px; }
    }
</style>

</head>
<body>

    <!-- ===== Header ===== -->
    <header>
        <h1>Cast2Vote - Admin Dashboard</h1>
        <button onclick="logout()">Logout</button>
    </header>

    <div class="container">

        <!-- ===== Election Countdown ===== -->
        <h2>Election Countdown</h2>
        <p id="countdown">Loading...</p>

        <!-- ===== Set Election ===== -->
        <h2>Set Election</h2>
        <input type="text" id="electionName" placeholder="Election Name">
        <input type="datetime-local" id="startTime">
        <input type="datetime-local" id="endTime">
        <button id="setElectionBtn" onclick="setElection()">Set Election</button>
        <p id="electionMsg"></p>

        <!-- ===== Pending Voters ===== -->
        <h2>Pending Voters</h2>
        <table id="pendingVotersTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>DOB</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- ===== Add Candidate ===== -->
        <h2>Add Candidate</h2>
        <input type="text" id="candName" placeholder="Candidate Name">
        <input type="text" id="candParty" placeholder="Party Name">
        <button id="addCandidateBtn" onclick="addCandidate()">Add Candidate</button>
        <p id="msg"></p>

        <!-- ===== Election Results ===== -->
        <h2>Election Results</h2>
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Party</th>
                    <th>Votes</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- ===== Send Winner Email ===== -->
        <h2>Send Winner Email</h2>
        <button class="send-winner" onclick="sendWinnerEmail()">Send Winner Email</button>
        <p id="emailMsg"></p>

    </div>

<script>
    let electionStart = null;
    let electionEnd = null;
    let countdownInterval = null;

    const addCandidateBtn = document.getElementById('addCandidateBtn');
    const sendWinnerBtn = document.querySelector('.send-winner');

    async function loadElectionTimer() {
        try {
            const res = await fetch('http://localhost:8080/election/timer');
            const data = await res.json();

            if (!data.startTime || !data.endTime) {
                document.getElementById('countdown').innerText = "No active election";
                addCandidateBtn.disabled = false;
                sendWinnerBtn.disabled = false;
                return;
            }

            electionStart = new Date(data.startTime);
            electionEnd = new Date(data.endTime);

            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(updateCountdown, 1000);
            updateCountdown();
        } catch (err) {
            console.error(err);
            document.getElementById('countdown').innerText = "Failed to load election timer";
        }
    }

    function updateCountdown() {
        const now = new Date();
        let text = "";

        if (!electionStart || !electionEnd) {
            text = "No active election";
        } else if (now < electionStart) {
            text = "Election starts in " + formatTime(electionStart - now);
        } else if (now >= electionStart && now <= electionEnd) {
            text = "Election ends in " + formatTime(electionEnd - now);
        } else {
            text = "Election has ended!";
        }

        document.getElementById('countdown').innerText = text;
        addCandidateBtn.disabled = false;
        sendWinnerBtn.disabled = false;
    }

    function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${hours}h ${minutes}m ${seconds}s`;
    }

    async function setElection() {
        const name = document.getElementById('electionName').value;
        const start = document.getElementById('startTime').value;
        const end = document.getElementById('endTime').value;

        if (!name || !start || !end) {
            document.getElementById('electionMsg').innerText = "❌ Please provide election name, start and end times.";
            return;
        }

        try {
            const res = await fetch('http://localhost:8080/election/set', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, startTime: start, endTime: end })
            });

            if (res.ok) {
                document.getElementById('electionMsg').innerText = "✅ Election set successfully!";
                electionStart = new Date(start);
                electionEnd = new Date(end);
                if (countdownInterval) clearInterval(countdownInterval);
                countdownInterval = setInterval(updateCountdown, 1000);
                updateCountdown();
            } else {
                document.getElementById('electionMsg').innerText = "❌ Failed to set election.";
            }
        } catch (err) {
            console.error(err);
            document.getElementById('electionMsg').innerText = "❌ Error setting election.";
        }
    }

    async function loadPendingVoters() {
        const res = await fetch('http://localhost:8080/admin/pending-voters');
        const voters = await res.json();
        const tbody = document.querySelector('#pendingVotersTable tbody');
        tbody.innerHTML = '';
        voters.forEach(v => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${v.name}</td>
                <td>${v.email}</td>
                <td>${v.dob}</td>
                <td>
                    <button class="approve" onclick="approve(${v.id})">Approve</button>
                    <button class="reject" onclick="reject(${v.id})">Reject</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function approve(id) {
        const res = await fetch(`http://localhost:8080/admin/approve/${id}`, { method: 'POST' });
        const msg = await res.text();
        document.getElementById('msg').innerText = msg;
        loadPendingVoters();
        loadResults();
    }

    async function reject(id) {
        const res = await fetch(`http://localhost:8080/admin/reject/${id}`, { method: 'POST' });
        const msg = await res.text();
        document.getElementById('msg').innerText = msg;
        loadPendingVoters();
    }

    async function addCandidate() {
        const candidate = {
            name: document.getElementById('candName').value,
            party: document.getElementById('candParty').value
        };
        const res = await fetch('http://localhost:8080/candidates/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(candidate)
        });
        if (res.ok) {
            document.getElementById('msg').innerText = "✅ Candidate added!";
            document.getElementById('candName').value = '';
            document.getElementById('candParty').value = '';
            loadResults();
        }
    }

    async function deleteCandidate(id) {
        const res = await fetch(`http://localhost:8080/candidates/delete/${id}`, { method: 'DELETE' });
        const msg = await res.text();
        document.getElementById('msg').innerText = msg;
        loadResults();
    }

    async function loadResults() {
        const res = await fetch('http://localhost:8080/candidates/results');
        const candidates = await res.json();
        const tbody = document.querySelector('#resultsTable tbody');
        tbody.innerHTML = '';
        candidates.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${c.name}</td>
                <td>${c.party}</td>
                <td>${c.votes}</td>
                <td><button class="delete" onclick="deleteCandidate(${c.id})">Delete</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function sendWinnerEmail() {
        const res = await fetch('http://localhost:8080/voters/sendWinnerEmail', { method: 'POST' });
        const msg = await res.text();
        document.getElementById('emailMsg').innerText = msg;
    }

    function logout() {
        window.location.href = 'admin-login.html';
    }

    // Initial Load
    loadElectionTimer();
    loadPendingVoters();
    loadResults();
</script>
</body>
</html>
